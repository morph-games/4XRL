(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();const B=(n,t=0,e=1)=>n<t?t:n>e?e:n,kt=999999,et=36;class f{constructor(t=1){this.n=Math.random()*t}get(){return this.n}static get(){return Math.random()}static random(){return Math.random()}static randomInt(t=0){return Math.floor(Math.random()*t)}static randomBell(t=1){return Math.random()*t-Math.random()*t}static randomAngle(){return Math.random()*Math.PI*2}static pickRandom(t=[]){return t[f.randomInt(t.length)]}static randomString(t=kt){return Math.round(Math.random()*t).toString(et)}static uniqueString(){return Number(new Date).toString(et)+f.randomString()}static pick(t=[]){return t[f.randomInt(t.length)]}static chance(t=0){return Math.random()>t}}function ct(n,t){const[e,s]=n;return Math.sqrt((e-t[0])**2+(s-t[1])**2)}function at(n,t,e){const[s,o]=n,i=Math.floor(t);for(let r=o-i;r<=o+i;r+=1)for(let c=s-i;c<=s+i;c+=1){const a=ct(n,[c,r]);a<=t&&e(c,r,a)}}function lt(n,t){return[n[0]+t[0],n[1]+t[1]]}function dt(n,t){return[n[0]-t[0],n[1]-t[1]]}const F=["food","science","culture","gold","production"],Ut={food:"🌾",science:"🧪",culture:"🎭",gold:"🪙",production:"⚙️"},N=()=>{},ut=[-1,-1],ht=[0,-1],ft=[1,-1],mt=[-1,0],pt=[1,0],gt=[-1,1],yt=[0,1],Et=[1,1],At=[0,0],Tt=[ht,ft,pt,Et,yt,gt,mt,ut];class l{constructor(t=[],e=void 0){this.arr=null,this.size=[...t],this.arr=this.getBlankArray(e)}static loopOverGrid(t,e=N,s=N,o=N){const[i,r]=t;for(let c=0;c<r;c+=1){s(c);for(let a=0;a<i;a+=1)e(a,c);o(c)}}static getFlexibleXYArguments(t){return[...t[0]instanceof Array?[...t[0]]:[t[0],t[1]]]}forEachCell(t=N,e=N,s=N){return l.loopOverGrid(this.size,t,e,s)}getBlankArray(t){const e=[];return this.forEachCell((s,o)=>e[o].push(t),()=>e.push([])),e}get(...t){const[e,s]=l.getFlexibleXYArguments(t);try{return this.arr[s][e]}catch{}}set(...t){const[e,s]=l.getFlexibleXYArguments(t),o=t[0]instanceof Array?t[1]:t[2];try{this.arr[s][e]=o}catch{}}clear(t){this.arr=this.getBlankArray(t)}onEdge(...t){const[e,s]=l.getFlexibleXYArguments(t);if(e===0||s===0)return!0;const[o,i]=this.size;return e===o-1||s===i-1}inBounds(...t){const[e,s]=l.getFlexibleXYArguments(t);if(e<0||s<0)return!1;const[o,i]=this.size;return e<o&&s<i}}l.DIRECTIONS=Tt;l.NW=ut;l.N=ht;l.NE=ft;l.W=mt;l.E=pt;l.SW=gt;l.S=yt;l.SE=Et;l.ZERO=At;function Nt(n=1,t=0){return t+Math.random()*(n-t)}function nt(n,t=0){return Math.floor(Nt(n,t))}const xt={W:{name:"water",land:!1},G:{name:"ground",land:!0}},q=()=>{};let Lt=class{constructor(t,e,s=18){this.size=[t,e],this.terrain=new l(this.size,null),this.tileSize=s,this.generate()}getPixelSize(){return[this.size[0]*this.tileSize,this.size[1]*this.tileSize]}loopOverMap(t=q,e=q,s=q){return this.terrain.forEachCell(t,e,s)}inBounds(t,e){return this.terrain.inBounds(t,e)}getTerrainTypeObject(t){return xt[this.terrain.get(t)]}isLand(t){return this.getTerrainTypeObject(t).land}generate(){const[e,s]=this.size,o=e/2,i=s/2,r=Math.hypot(o,i);this.terrain.clear();const c=(a,u)=>{const g=Math.hypot(o-a,i-u)/r;return Math.random()+.1>g?"G":"W"};this.loopOverMap((a,u)=>{this.terrain.set(a,u,c(a,u))}),this.loopOverMap((a,u)=>{this.terrain.onEdge(a,u)&&this.terrain.set(a,u,"W")})}render(){let t="";this.loopOverMap((e,s)=>{const o=this.terrain.get(e,s);t+=`<div class="map-cell map-terrain-${o}" id="map-cell-${e}-${s}"></div>`},()=>{t+='<div class="map-row">'},()=>{t+="</div>"}),document.getElementById("map-terrain").innerHTML=t}getRandomCoordinates(t){if(!t){const[o,i]=this.size;return[nt(0,o),nt(0,i)]}const e=1e3;let s=[0,0];for(let o=0;o<e;o+=1){s=this.getRandomCoordinates();const[i,r]=s;if(this.terrain.get(i,r)===t)return s}return s}};function Ct(n=""){return[n,Number(new Date).toString(36),Math.round(Math.random()*9999)].join("_")}const $t=Math.PI*2;class Ot{constructor(t,e,s,o){this.color=s,this.nationalClass=e,this.id=t||Ct("N"),F.forEach(i=>{this[i]=0}),this.blood=0,this.fog=new l(o.size,1),this.borders=new l(o.size,0),this.map=o,this.capital=null}forEachCurrency(t){F.forEach(e=>{t(e,this[e])})}gain(t={}){this.forEachCurrency(e=>{t[e]&&(this[e]+=Number(t[e]))})}canPay(t={}){let e=!0;return this.forEachCurrency(s=>{this[s]<Number(t[s]||0)&&(e=!1)}),e}pay(t={}){this.forEachCurrency(e=>{t[e]&&(this[e]-=Number(t[e]))})}claim(t,e=.72,s=1){return this.borders.get(t)>=e||this.culture<s?!1:(this.culture-=s,this.borders.set(t,e),!0)}clearFog(t,e=0){this.fog.set(t,0),at(t,e,(s,o)=>{this.fog.set(s,o,0)})}getNationalUnits(t){return t.filter(e=>e.nationId===this.id)}renderBorder(t,e,s="map-borders"){const o=document.getElementById("map-borders-fill"),[i,r]=t;o.width=i,o.height=r;const c=o.getContext("2d");c.clearRect(0,0,i,r);const a=e/2;this.borders.forEachCell((C,R)=>{if(!this.borders.get(C,R))return;const U=C*e+a,P=R*e+a;c.beginPath(),c.arc(U,P,this.borders.get(C,R)*e,0,$t),c.fillStyle="#fff",c.fill(),c.closePath()});const u=document.getElementById(s);u.width=i,u.height=r;const d=u.getContext("2d");d.clearRect(0,0,i,r),d.fillStyle=this.color;const g=c.getImageData(0,0,i,r),{data:w}=g,Y=i*r,L=.8;for(let C=0;C<Y;C+=1){const U=C*4+3,P=i*4;if(w[U]>L)continue;const Q=w[U-4],K=w[U+4],V=w[U-P],J=w[U+P];if(K&&K>L||Q&&Q>L||J&&J>L||V&&V>L){const tt=parseInt(C/i,10),wt=C-tt*i;d.fillRect(wt,tt,1,1)}}d.fill()}renderFog(t,e,s="map-fog"){const o=document.getElementById(s);if(!o)throw Error(`Could not render fog to ${s}`);const[i,r]=t;o.width=i,o.height=r;const c=o.getContext("2d");c.clearRect(0,0,i,r),c.beginPath(),this.fog.forEachCell((a,u)=>{this.fog.get(a,u)&&c.rect(a*e,u*e,e,e)}),c.fillStyle="#000",c.fill(),c.closePath()}render(t,e){const s=t||this.map,o=s.getPixelSize();this.renderFog(o,s.tileSize,e),this.renderBorder(o,s.tileSize)}}class ${constructor(t,e="E",s=["thing"],o="map-cities"){this.id=Ct(e),this.coords=t,this.classes=s,this.containerId=o,this.removed=!1,this.decay=1/0}update(){this.decay-=1,this.decay<=0&&this.remove()}remove(){this.removed=!0,this.derez()}move(t,e){this.coords[0]+=t,this.coords[1]+=e}getMove(t,e){return[this.coords[0]+t,this.coords[1]+e]}getName(){return""}getInnerHtml(){return""}getDistance(t){return ct(this.coords,t)}getClassList(){return[this.id,...this.classes]}getContainerElement(){return document.getElementById(this.containerId)}getElement(t){return(t||this.getContainerElement()).querySelector(`.${this.id}`)}derez(){this.removed=!0;const t=this.getElement();t&&t.remove()}render(t){if(this.removed){this.derez();return}const e=this.getContainerElement();let s=this.getElement(e);if(!s){s=document.createElement("div"),s.dataset.id=this.id;const a=this.getName();a&&(s.title=a),e.appendChild(s)}try{s.classList.add(...this.getClassList())}catch(a){throw console.log(s),Error(a)}s.innerHTML=this.getInnerHtml()||"";const[o,i]=this.coords,[r,c]=t;s.style.transform=`translate(${o*r}px, ${i*c}px)`}}const k={attack:0,convert:0,bribe:0},S={L:{name:"Leader",intelligent:1,explore:.5,defense:{...k,bribe:2,convert:2},harvest:1,research:1,craft:1,invest:1,produce:1,specialNotes:"Can set flags to rally units",cost:null},W:{name:"Warrior",attack:2,defense:{...k,attack:1,bribe:2},harvest:0,invest:1,produce:1,specialNotes:"Good vs. Merchants",cost:{production:2,gold:1}},A:{name:"Artist",convert:2,defense:{...k,attack:2,convert:1},claim:1,harvest:1,research:1,craft:3,invest:1,specialNotes:"Can claim territory; Good vs. Warriors",cost:{culture:2,production:1}},M:{name:"Merchant",bribe:2,defense:{...k,bribe:1,convert:2},harvest:1,research:1,invest:3,craft:1,produce:1,specialNotes:"Good vs. Artists",cost:{gold:2,production:1}},E:{name:"Scout",explore:1.5,defense:{...k},harvest:1,research:1,craft:1,invest:1,produce:1,specialNotes:"Can remove fog of war 1 square in all directions",cost:{production:2}},B:{name:"Builder",defense:{...k},harvest:2,research:2,craft:1,invest:1,produce:3,cost:{production:1,culture:1,gold:1}},S:{name:"Scientist",defense:{...k},harvest:1,research:3,craft:1,invest:1,produce:1,cost:{production:1,culture:1,science:1}},F:{name:"Farmer",defense:{...k},harvest:3,research:0,craft:1,invest:1,produce:2,cost:{production:1,culture:1,science:1}}},Rt=9;class D extends ${constructor(t,e){super(e,"C",["city"],"map-cities"),this.nationId=t,this.population=1,this.availableUnitTiers={E:1,W:1,A:0,M:0,B:0,S:0,F:1},this.food=0}getMaxTier(){return Math.min(this.population,Rt)}static getTieredCost(t,e=1){const s={};return Object.keys(t).forEach(o=>{s[o]=(t[o]||0)*e}),s}getUnitTier(t){return this.availableUnitTiers[t]}getUnitBuildCost(t){const{cost:e}=S[t],s=this.getUnitTier(t);return D.getTieredCost(e,s)}getUnlockUnitTierCost(t){const e=this.getUnitTier(t);if(e>=this.getMaxTier())return{};const{cost:s}=S[t],o=D.getTieredCost(s,1);return o.science=(o.science||0)+(e+1)*2,o}unlockUnitTier(t){this.availableUnitTiers[t]=Math.min(this.availableUnitTiers[t]+1,this.getMaxTier())}getPopFoodThreshold(){return this.population*5}feed(t={}){this.food+=t.food||0;const e=this.getPopFoodThreshold();this.food<=e||(this.food-=e,this.population+=1)}getInfoHtml(){return`<h1>City <span class="pop">Pop: ${this.population}</span></h1>
			<div>🌾${this.food}/${this.getPopFoodThreshold()}</div>
		`}getInterfaceHtml(t){const e=Object.keys(this.availableUnitTiers),s=r=>Object.keys(r).map(c=>`${r[c]}${Ut[c]}`).join(" "),o=e.map(r=>{const c=this.availableUnitTiers[r],a=S[r],u=this.getUnitBuildCost(r),g=`
				<button type="button"
					${!t.canPay(u)?'disabled="disabled"':""}
					class="buy-unit"
					data-type="${r}"
					data-city="${this.id}"
					data-tier="${c}"
					>
					<span class="city-unit-cost">${s(u)}</span>
				</button>`;return`<li>
				<span>(${r}) ${a.name} <span class="tier">${c}</span></span>
				${c?g:"N/A"}
			</li>`}),i=e.map(r=>{const c=this.availableUnitTiers[r],a=S[r],u=this.getUnlockUnitTierCost(r),d=c===this.getMaxTier(),g=d?!0:!t.canPay(u),w=d?"MAX":`${c} &rarr; ${c+1}`,Y=d?"Raise pop":s(u);return`<li>
				<span>(${r}) ${a.name} <span class="tier">${w}</span></span>
				<button type="button"
					${g?'disabled="disabled"':""}
					class="upgrade-unit"
					data-type="${r}"
					data-city="${this.id}"
					>
					${Y}
				</button>
			</li>`});return`
			<div class="city-units">
				<input type="radio" id="show-build-list" name="show-city-list" checked="checked" />
				<label for="show-build-list">Build</label>
				<input type="radio" id="show-upgrade-list" name="show-city-list" />
				<label for="show-upgrade-list">Upgrade</label>
				<ul id="city-build-list">${o.join("")}</ul>
				<ul id="city-upgrade-list">${i.join("")}</ul>
			</div>
		`}getName(){const[t,e]=this.coords;return`City (${t}, ${e})`}getInnerHtml(){return this.population}}class Pt extends ${constructor(t,e,s){super(s,"D",["district"],"map-districts"),this.cityId=e,this.nationId=t}}const Bt={harvest:"🌾Harvest Food",research:"🧪Research Science",craft:"🎭Culture Crafting",invest:"🪙Invest Coins",produce:"⚙️Production"},st=["attack","convert","bribe"],Ht=["harvest","research","craft","invest","produce"];class zt extends ${constructor(t,e,s,o,i){super(o,"U",["unit"],"map-units"),this.nationId=t,this.nationalClass=e,this.type=s,this.displayHtml=i,this.commandQueue=[],this.maxAxisMovement=1,this.tier=1,this.dead=!1}queueCommand(t){this.commandQueue.push(t)}popCommand(){return this.commandQueue.shift()}clearCommands(){this.commandQueue.length=0}getSkill(t){return(S[this.type][t]||0)+(this.tier-1)}getAttackSkill(){return st.filter(e=>this.getSkill(e))[0]||null}getDefenseVersusAttack(t){return(S[this.type].defense[t]||0)+(this.tier-1)}kill(){this.dead=!0,this.remove()}getName(){return S[this.type].name}getInnerHtml(){return this.displayHtml||this.type}getInfoHtml(){const t=S[this.type],{defense:e}=t,s=d=>{let g="";return d>1?g="good":d<=0&&(g="bad"),`class="${g}"`},o=d=>`<span ${s(d)}>${d}</span>`,i=Object.keys(e).map(d=>`<li>${d}: ${o(e[d])}</li>`),r=Ht.map(d=>`<li>${Bt[d]}: x${o(this.getSkill(d))}</li>`),c=st.filter(d=>this.getSkill(d)),a=c.length?c.map(d=>`<li>${d}: ${this.getSkill(d)}</li>`):['<li class="bad">No attacks</li>'];return`
			<h1>${this.getName()} <span class="tier">Tier ${this.tier}</span></h1>
			<div>
				Harvest skills:
				<ul>
					${r.join("")}
				</ul>
			</div>
			<div>
				Attacks:
				<ul>
					${a.join("")}
				</ul>
			</div>
			<div>
				Defense versus...
				<ul>
					${i.join("")}
				</ul>
			</div>
			${t.specialNotes?`<div>Notes: ${t.specialNotes}</div>`:""}
		`}move(t,e){const s=this.maxAxisMovement*-1;super.move(B(t,s,this.maxAxisMovement),B(e,s,this.maxAxisMovement))}getMove(t,e){const s=this.maxAxisMovement*-1;return super.getMove(B(t,s,this.maxAxisMovement),B(e,s,this.maxAxisMovement))}isIntelligent(){return typeof this.intelligent>"u"?S[this.type].intelligent||0:this.intelligent}getClassList(){return[this.id,...this.classes,this.nationalClass]}}const H={wheat:{currency:"food",pickUpSkill:"harvest",amount:1,emoji:"🌾"},discovery:{currency:"science",pickUpSkill:"research",amount:1,emoji:"🧪"},artwork:{currency:"culture",pickUpSkill:"craft",amount:1,emoji:"🎭"},riches:{currency:"gold",pickUpSkill:"invest",amount:1,emoji:"🪙"},production:{currency:"production",pickUpSkill:"produce",amount:1,emoji:"⚙️"},corpse:{currency:"blood",pickUpSkill:"produce",amount:1,decay:10,emoji:"💀"}},Ft=["wheat","discovery","artwork","riches","production"];class Dt extends ${constructor(t,e="random"){super(t,"R",["resource"],"map-resources"),this.type=e,(this.type==="random"||!this.type)&&this.assignRandomType(),this.decay=H[this.type].decay||1/0}assignRandomType(){return this.type=f.pickRandom(Ft),this.type}getPickUpSkill(){return H[this.type].pickUpSkill}canUnitPickUp(t){const e=this.getPickUpSkill();return t.getSkill(e)>0}unitPicksUp(t){const e={};if(!this.canUnitPickUp(t))return e;const s=this.getPickUpSkill(),{currency:o,amount:i}=H[this.type];return e[o]=t.getSkill(s)*i,e}getName(){return this.type}getInnerHtml(){return H[this.type].emoji}}class Wt extends ${constructor(t,e,s=[],o=[]){super(o,"F",["flag",...s],"map-flags"),this.nationId=t,this.type=e,this.followUnitId=null,this.magnetizedUnitId=null,this.decay=50}magnetize(t){if(this.magnetizedUnitId&&t.get(this.magnetizedUnitId))return this.magnetizedUnitId;const e={},s=t.getKeys().filter(i=>{const r=t.get(i),c=r.nationId===this.nationId&&r.type===this.type;return c&&(e[i]=r.getDistance(this.coords)),c});if(s.length===0)return null;s.sort((i,r)=>e[i]-e[r]);const[o]=s;return this.magnetizedUnitId=o,this.magnetizedUnitId}getClassList(){return[this.id,...this.classes]}getInnerHtml(){return`🚩<sup>${this.type}</sup>`}}class x extends Map{constructor(t){super(),this.MyClass=t}update(){this.forEach(t=>{t.update&&t.update(),t.removed&&this.remove(t)})}add(t){if(!t.id)throw new Error("Can only add items with an id");super.set(t.id,t)}addNew(...t){const e=new this.MyClass(...t);return e.setup&&e.setup(),this.add(e),e}remove(t){const e=typeof t=="object"?t.id:t;this.get(e).remove(),this.delete(e)}getKeys(){return Array.from(this.keys())}findAt(t=[]){let e;const[s,o]=t;return this.forEach(i=>{i.coords[0]===s&&i.coords[1]===o&&(e=i)}),e}filter(t){const e=[];return this.forEach(s=>{t(s)&&e.push(s)}),e}render(t){this.forEach(e=>{e.render(t)})}}const jt=1.5,Xt=200,W=20,Yt=18,qt=W*W/8,_t=(n=1)=>new Promise(t=>{setTimeout(t,n)}),b=new x(Ot),E=new x(D),vt=new x(Pt),m=new x(zt),M=new x(Dt),T=new x(Wt),p=new Lt(W,W,Yt);let A="";const h={turn:0,turnsToDo:0,nations:b,cities:E,districts:vt,units:m,resources:M,flags:T,map:p,enemy1:null,pc:null,freeStuff(){F.forEach(n=>{y[n]+=100})}},y=b.addNew("player","nation0","#ffff00",p);h.enemy1=b.addNew("enemy","nation1","#ff0000",p);function It(){const n=[];return E.forEach(t=>n.push(t.coords)),vt.forEach(t=>n.push(t.coords)),m.forEach(t=>n.push(t.coords)),M.forEach(t=>n.push(t.coords)),T.forEach(t=>n.push(t.coords)),n}function G(n,t=0){if(t>Xt)return null;const e=n||It(),[s,o]=p.size,i=f.randomInt(s),r=f.randomInt(o);return e.reduce((a,u)=>u[0]===i&&u[1]===r?a+1:a,0)>0?G(e,t+1):[i,r]}function z([n,t]){return It().reduce((o,i)=>i[0]===n&&i[1]===t?o+1:o,0)>0}function O(n,t,e,s,o=0){let i=f.pickRandom(l.DIRECTIONS);if(o>20&&console.log("Trying to find location to spawn unit",o),o>50&&(i=[i[0]*2,i[1]*2]),o>100)return console.error("Could not find spot for unit"),null;const r=lt(s.coords,i);return z(r)?O(n,t,e,s,o+1):m.addNew(n,t,e,r)}function Gt(){const n=p.getRandomCoordinates("G"),t=E.addNew(y.id,n);y.capital=t,y.clearFog(n,2),h.pc=m.addNew(y.id,"nation0","L",lt(t.coords,[-1,1]),"@"),h.pc.intelligent=0,["W","A","M","E"].forEach(e=>{O(y.id,"nation0",e,t)}),m.forEach(e=>{e.nationId===y.id&&y.clearFog(e.coords)}),y.claim(t.coords,2,0)}function Zt(){let n=p.getRandomCoordinates("G");if(z(n)&&(n=p.getRandomCoordinates("G")),z(n)&&(n=p.getRandomCoordinates("G")),z(n))throw Error("bad coords");h.enemy1.capital=E.addNew(h.enemy1.id,n),h.enemy1.clearFog(n,2),["L","W","W","E"].forEach(t=>{O(h.enemy1.id,"nation1",t,h.enemy1.capital)})}function Qt(){Gt(),Zt()}function Kt(n,t,e){T.addNew(n.nationId,t,[n.nationalClass],e)}function Vt(n,t,e){console.log("COMBAT",n,t,e);const s=t.getSkill(n)+f.randomInt(2),o=e.getDefenseVersusAttack(n)+f.randomInt(2);console.log(s,"vs",o),s>o&&(M.addNew(e.coords,"corpse"),e.kill())}async function Jt(n){const t=n.popCommand();if(!t)return!1;const e=typeof t=="string"?t:t[0];if(await _t(50),e==="move"){const[,s,o]=t,[i,r]=n.getMove(s,o);return p.inBounds(i,r)?(n.move(s,o),!0):!1}if(e==="spawn"){const[,s,o,i,r]=t,c=n.getMove(i,r);return s==="flag"&&Kt(n,o,c),!0}if(e==="attack"){const[,s,o]=t,i=m.findAt(o);if(!i)return console.warn(n.id,"could not attack",o," - no unit found"),!1;Vt(s,n,i)}return!1}function te(n){const t=n.getAttackSkill();if(!t)return;const e=[];if(at(n.coords,jt,(o,i)=>{const r=[o,i],c=m.findAt(r);c&&c.nationId!==n.nationId&&e.push(r)}),!e.length)return;const s=f.pickRandom(e);n.clearCommands(),n.queueCommand(["attack",t,s])}async function ot(n){te(n),await Jt(n);const t=b.get(n.nationId),e=M.findAt(n.coords);if(e&&e.canUnitPickUp(n)){const i=e.unitPicksUp(n);t.gain(i),M.remove(e)}const s=n.getSkill("explore");s&&t.clearFog(n.coords,s),n.getSkill("claim")&&p.isLand(n.coords)&&t.claim(n.coords),n.isIntelligent()&&oe(n)}function ee(n){const t=n.magnetize(m);if(!t)return;const e=m.get(t),[s,o]=dt(n.coords,e.coords);if(s===0&&o===0){T.remove(n.id);return}e.queueCommand(["move",s,o])}function ne(){T.forEach(n=>ee(n))}function se(){if(M.size>=qt)return;const n=G();n&&(f.chance(.5)||M.addNew(n))}function oe(n){const t=b.get(n.nationId);if(f.chance(.5)){const e=G();if(!e){console.warn("cannot plan without coords");return}const s=dt(e,n.coords);n.queueCommand(["move",s[0],s[1]])}else{const e=f.pickRandom(l.DIRECTIONS),s=t.getNationalUnits(m).filter(i=>!i.isIntelligent()).map(i=>i.type),o=f.pickRandom(s);n.queueCommand(["spawn","flag",o,e[0],e[1]])}}function ie(){E.forEach(n=>{const t=b.get(n.nationId),e={food:1};t.canPay(e)&&(t.pay(e),n.feed(e))})}function re(){const n=h.enemy1,t=f.pickRandom(F),e={};if(e[t]=1,n.gain(e),f.random()>.95){const s=f.pickRandom(["W","W","W","E","A","M"]);O(n.id,n.nationalClass,s,n.capital)}}async function ce(){if(h.turnsToDo<=0){console.warn("No more turns left");return}await ot(h.pc),rt(h.pc),ne();const n=m.filter(t=>t!==h.pc);for(let t=0;t<n.length;t+=1){const e=n[t];await ot(e),rt(e)}se(),re(),ie(),E.update(),M.update(),m.update(),T.update(),h.turn+=1,j(),h.turnsToDo-=1}function it(){if(m.filter(e=>e.nationId===h.enemy1.id).length===0&&document.querySelector("main").classList.add("game-won"),!h.pc.dead&&!h.pc.removed)return;h.gameOver=!0,document.querySelector("main").classList.add("game-over")}async function Z(n=0){it(),h.turnsToDo+=n,await ce(),h.turnsToDo>0&&await Z(),it()}function St(){const t=document.querySelector(".map-cell").getBoundingClientRect();return[t.width,t.height]}function Mt(){const t=A?{"flag-E":"Move Explorer","flag-F":"Move Farmer","flag-W":"Move Warrior","flag-M":"Move Merchant","flag-A":"Move Artist","flag-B":"Move Builder","flag-S":"Move Scientist"}[A]:"Move Leader";document.getElementById("direction-action-text").innerHTML=t,y.forEachCurrency((e,s)=>{document.getElementById(`stats-${e}`).innerText=s}),document.querySelectorAll(".action-list button").forEach(e=>{const{classList:s}=e;A&&s.contains(A)?s.add("selected-action"):s.remove("selected-action")})}function rt(n){const t=St();n.render(t)}function j(){const n=St();E.render(n),m.render(n),M.render(n),T.render(n),y.render(p,"map-player-fog"),Mt()}function X(){return document.querySelector("main").classList}function ae(n){X().add("show-info");const t=document.getElementById("info-content");t.innerHTML=n}function le(){const n=document.getElementById("info-content");n.innerHTML="",X().remove("show-info")}function de(n){const t=n.getInfoHtml();ae(t)}function _(){const n=document.getElementById("city-info-content");n.innerHTML="",X().remove("show-city-view")}function ue(n){const t=b.get(n.nationId);X().add("show-city-view"),document.getElementById("city-info-content").innerHTML=n.getInfoHtml(),document.getElementById("city-interface").innerHTML=n.getInterfaceHtml(t)}function I(n){A=n,Mt()}function v(n){const[t,e]=n;if(A){const s=A.split("-");s[0]==="flag"&&h.pc.queueCommand(["spawn","flag",s[1],t,e]),I("")}else h.pc.queueCommand(["move",t,e]);Z(1)}function he(n,t){const e=E.get(n),s=b.get(e.nationId),o=e.getUnlockUnitTierCost(t);s.canPay(o)&&(s.pay(o),e.unlockUnitTier(t),j())}function fe(n,t){const e=E.get(n),s=b.get(e.nationId),o=e.getUnitBuildCost(t);if(!s.canPay(o))return;s.pay(o);const i=O(s.id,s.nationalClass,t,e);i.tier=e.getUnitTier(t),j()}const bt={"dir-up-left":()=>{v(l.NW)},"dir-up":()=>{v(l.N)},"dir-up-right":()=>{v(l.NE)},"dir-left":()=>{v(l.W)},"dir-none":()=>{v(l.ZERO)},"dir-right":()=>{v(l.E)},"dir-down-left":()=>{v(l.SW)},"dir-down":()=>{v(l.S)},"dir-down-right":()=>{v(l.SE)},"flag-E":()=>I("flag-E"),"flag-F":()=>I("flag-F"),"flag-W":()=>I("flag-W"),"flag-M":()=>I("flag-M"),"flag-A":()=>I("flag-A"),"flag-B":()=>I("flag-B"),"flag-S":()=>I("flag-S"),"move-wait":()=>{Z(1),I("")}},me=Object.keys(bt),pe=[{selector:"#actions",handler:n=>{const t=me.filter(e=>n.target.classList.contains(e));t.length&&bt[t[0]](n)}},{selector:"#map-units",handler:n=>{const t=n.target.closest(".unit");if(!t)return;const e=m.get(t.dataset.id);de(e)}},{selector:"#map-cities",handler:n=>{const t=n.target.closest(".city");if(!t)return;const e=E.get(t.dataset.id);ue(e)}},{selector:"#city-view",handler:n=>{n.target.closest(".close-button")&&_();const t=n.target.closest(".buy-unit");if(t){const{city:s,type:o}=t.dataset;fe(s,o),_()}const e=n.target.closest(".upgrade-unit");if(e){const{city:s,type:o}=e.dataset;he(s,o),_()}}},{selector:"#info",handler:n=>{n.target.closest(".close-button")&&le()}}];function ge(){pe.forEach(({selector:n,handler:t})=>{document.querySelector(n).addEventListener("click",t)})}document.addEventListener("DOMContentLoaded",()=>{Qt(),ge(),p.render(),j()});window.map=p;window.game=h;
